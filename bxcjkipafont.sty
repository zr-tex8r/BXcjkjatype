% bxcjkipafont.sty

%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bxcjkipafont}[2013/01/25 v0.2]

%% load packages
\RequirePackage{ifpdf}
\RequirePackage{etoolbox}
\RequirePackage{keyval}

%% preparations
\def\bxqci@pkgname{bxcjkipafont}
\def\bxqci@error{\PackageError\bxqci@pkgname}

%% \bxqci@mainfam: main CJK family
\let\bxqci@mainfam\relax
%% bxqci@fancy: whether to use 'fancy' family setting
\newbool{bxqci@fancy}
%% \bxqci@whole: wrap-whole environment name
\let\bxqci@whole\@empty

%% handle options
% mainfamily=<fam>: sets \bxqci@mainfam
\define@key{bxqci}{mainfamily}{%
  \edef\bxqci@mainfam{#1}%
}
% fancy=<bool>: sets bxqci@fancy
\define@key{bxqci}{fancy}[true]{%
  \setbool{bxqci@fancy}{#1}%
}
% whole={CJK|CJK*|none}: sets \bxqci@whole
\define@key{bxqci}{whole}{%
  \bxqci@whole@into{#1}{'whole'}%
}
\@onlypreamble\bxqci@whole@into
\def\bxqci@whole@into#1#2{%
  \let\bxqci@whole\@undefined
  \ifstrequal{#1}{CJK}{\def\bxqci@whole{CJK}}{}%
  \ifstrequal{#1}{CJK*}{\def\bxqci@whole{CJK*}}{}%
  \ifstrequal{#1}{none}{\let\bxqci@whole\@empty}{}%
  \unless\ifdefined\bxqci@whole
    \bxqci@error{Invalid value for #2 (#1)}%
      \@ehc
    \let\bxqci@whole\@empty
  \fi
}
% handles key-value options
\DeclareOption*{%
  \def\bxqci@next{\setkeys{bxqci}}%
  \expandafter\bxqci@next\expandafter{\CurrentOption}%
}
\ProcessOptions*

%% environment check
\@ifpackageloaded{CJK}{}{%else
  \bxqci@error{Package 'CJK' is not yet loaded}%
  \@ehc
  \RequirePackage{CJK}%
}
\IfFileExists{c70zhsong.fd}{}{%else
  \bxqci@error{Package 'zhmetrics' is not available}%
}

%--------------------------------------- helpers

%% \bxqci@mapline@n{<tfm-base>}{<font-file>}
%% \bxqci@mapline@s{<tfm-base>}{<font-file>}
\@onlypreamble\bxqci@mapline@n
\@onlypreamble\bxqci@mapline@s
\ifpdf                  %<*pdftex>
\def\bxqci@mapline@n#1#2{%
  \pdfmapline{=#1@Unicode@ <#2}%
}
\let\bxqci@mapline@s\bxqci@mapline@n
\else                   %<*dvipdfmx>
\@onlypreamble\bxqci@mapline
\def\bxqci@mapline#1{\AtBeginDvi{\special{pdf:mapline #1}}}
\def\bxqci@mapline@n#1#2{%
  \bxqci@mapline{+#1@Unicode@ unicode #2}%
}
\def\bxqci@mapline@s#1#2{%
  \bxqci@mapline{+#1@Unicode@ unicode #2 -s .167}%
}
\fi                     %</>

%% \bxqci@decl@family{<family>}{<tfm-base>}{<font-file>}
\@onlypreamble\bxqci@decl@family
\ifbxqci@fancy
\def\bxqci@decl@family#1#2#3{%
  \cslet{bxqci@fam/#1}{t}%
  \DeclareFontFamily{C70}{#1}{\hyphenchar\font\m@ne}%
  \DeclareFontShape{C70}{#1}{m}{n}{<->CJK*#2}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{b}{n}{<->CJKb*#2}{\CJKbold}%
  \DeclareFontShape{C70}{#1}{bx}{n}{<->ssub*#1/b/n}{\CJKbold}%
  \DeclareFontShape{C70}{#1}{m}{sl}{<->CJK*#2sl}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{b}{sl}{<->CJKb*#2sl}{\CJKbold}%
  \DeclareFontShape{C70}{#1}{bx}{sl}{<->ssub*#1/b/sl}{\CJKbold}%
  \DeclareFontShape{C70}{#1}{m}{it}{<->ssub*#1/m/sl}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{b}{it}{<->ssub*#1/b/sl}{\CJKbold}%
  \DeclareFontShape{C70}{#1}{bx}{it}{<->ssub*#1/bx/sl}{\CJKbold}%
  \bxqci@mapline@n{#2}{#3}%
  \bxqci@mapline@s{#2sl}{#3}%
}
\else
\def\bxqci@decl@family#1#2#3{%
  \cslet{bxqci@fam/#1}{t}%
  \DeclareFontFamily{C70}{#1}{\hyphenchar\font\m@ne}%
  \DeclareFontShape{C70}{#1}{m}{n}{<->CJK*#2}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{b}{n}{<->ssub*#1/m/n}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{bx}{n}{<->ssub*#1/m/n}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{m}{sl}{<->CJK*#2sl}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{b}{sl}{<->ssub*#1/m/sl}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{bx}{sl}{<->ssub*#1/m/sl}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{m}{it}{<->ssub*#1/m/sl}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{b}{it}{<->ssub*#1/b/sl}{\CJKnormal}%
  \DeclareFontShape{C70}{#1}{bx}{it}{<->ssub*#1/bx/sl}{\CJKnormal}%
  \bxqci@mapline@n{#2}{#3}%
  \bxqci@mapline@n{#2sl}{#3}%
}
\fi

%% prepare a hook
\let\bxqci@CJKhook\@empty
\appto\CJKhook{\bxqci@CJKhook}

%--------------------------------------- CJK family declarations

\bxqci@decl@family{ipam}{unisong}{ipam.ttf}
\bxqci@decl@family{ipag}{unihei}{ipag.ttf}
\ifx\bxqci@mainfam\relax
  \def\bxqci@mainfam{ipam}
\fi
\ifcsdef{bxqci@fam/\bxqci@mainfam}{}{%else
  \bxqci@error{Main family '\bxqci@mainfam' is invalid}%
    \@ehc
  \def\bxqci@mainfam{ipam}
}
\CJKencfamily{UTF8}{\bxqci@mainfam}

%--------------------------------------- some utilities

%%<*> 'uCJK*' environment
\csdef{uCJK*}{\csuse{CJK*}{UTF8}{}}
\csletcs{enduCJK*}{endCJK*}
%%<*> 'uCJK' environment
\newcommand*{\uCJK}{}
\csdef{uCJK}{\csuse{CJK}{UTF8}{}}
\csletcs{enduCJK}{endCJK}

%%<*> \ipamfamily
\newcommand*{\ipamfamily}{\CJKfamily{ipam}}
%%<*> \ipagfamily
\newcommand*{\ipagfamily}{\CJKfamily{ipag}}

%--------------------------------------- wrap-whole environment

%%<*> \wholeintoCJKenv{<name>}
\@onlypreamble\wholeintoCJKenv
\newcommand*{\wholeintoCJKenv}[1]{%
  \bxqci@whole@into{#1}{\string\wholeintoCJKenv}%
}

%% \bxqci@begin@env/\bxqci@end@env
\let\bxqci@begin@env\@empty
\let\bxqci@end@env\@empty

%% \bxqci@switch@env
\@onlypreamble\bxqci@switch@env
\def\bxqci@switch@env{%
  \expandafter\bxqci@swenv@a\bxqci@whole\relax
}
\def\bxqci@swenv@a#1\relax{%
  \ifstrempty{#1}{}{%else
    \def\bxqci@begin@env{\begin{#1}{UTF8}{}}%
    \def\bxqci@end@env{\end{#1}}%
  }%
}

%% hooks
\AtBeginDocument{%
  \bxqci@switch@env
  \bxqci@begin@env
}
\AtEndDocument{%
  \bxqci@end@env
}

%--------------------------------------- auto CJKtilde

\newtoggle{bxqci@tilde}

%%<*> \autoCJKtilde
\newcommand*{\autoCJKtilde}{%
  \toggletrue{bxqci@tilde}%
}
%%<*> \noautoCJKtilde
\newcommand*{\noautoCJKtilde}{%
  \togglefalse{bxqci@tilde}%
}

%% hook
\appto\bxqci@CJKhook{%
  \iftoggle{bxqci@tilde}{\CJKtilde}{}%
}

%--------------------------------------- done
\endinput
